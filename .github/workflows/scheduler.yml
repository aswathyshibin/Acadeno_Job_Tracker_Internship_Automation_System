name: Kerala IT Park Job Scraper Automation

on:
  schedule:
    - cron: '30 2,15 * * *'   # 8:00 AM & 9:00 PM IST
    - cron: '50 10 * * *'     # 4:20 PM IST
  workflow_dispatch:

jobs:
  run-script:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install selenium requests beautifulsoup4 reportlab webdriver-manager

      - name: Run Maitexa job scraper
        run: python app.py

      - name: Upload PDF Report
        uses: actions/upload-artifact@v4
        with:
          name: Maitexa_Job_Brochure
          path: Maitexa_Green_Adjusted_Brochure.pdf

      - name: Send professional email with brochure
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
        run: |
          python - <<'EOF'
          import os, time, smtplib
          from email.mime.text import MIMEText
          from email.mime.multipart import MIMEMultipart
          from email.mime.base import MIMEBase
          from email import encoders
          from datetime import datetime

          sender = os.getenv("EMAIL_USER")
          password = os.getenv("EMAIL_PASS")
          recipients = [x.strip() for x in os.getenv("EMAIL_TO", "").split(",") if x.strip()]

          pdf_file = "Maitexa_Green_Adjusted_Brochure.pdf"
          for _ in range(10):
              if os.path.exists(pdf_file):
                  break
              time.sleep(2)

          # Read job count
          job_count = 0
          if os.path.exists("app.log"):
              with open("app.log") as f:
                  for line in f:
                      if "Found" in line and "jobs" in line:
                          job_count = int("".join(filter(str.isdigit, line)))
                          break

          msg = MIMEMultipart("alternative")
          msg["From"] = f"Maitexa Technologies <{sender}>"
          msg["To"] = ", ".join(recipients)
          msg["Subject"] = f"üåø Maitexa Kerala IT Jobs ‚Äì {datetime.now().strftime('%d %b %Y, %I:%M %p')}"

          html_content = f"""
          <html><body style="font-family: Arial; font-size:15px; color:#222;">
          <p>Dear Team,</p>
          <p>We‚Äôre excited to share today‚Äôs curated <strong>Maitexa Kerala IT Jobs Brochure</strong> featuring opportunities across Infopark, Technopark, and Cyberpark.</p>
          <p style="color:#007A33;"><strong>‚úÖ {job_count if job_count else 'Several'} new technical openings (excluding Java)</strong></p>
          <p><em>Great opportunities don‚Äôt happen ‚Äî you create them.</em><br>Keep learning, keep growing, and make today count.</p>
          <p style="margin-top:20px;">Best Wishes,<br>
          <strong style="color:#007A33;">Maitexa Technologies Pvt Ltd</strong><br>
          Kadannamanna, Malappuram, Kerala ‚Äì 679324<br>
          <a href='mailto:contact@maitexa.com'>contact@maitexa.com</a> |
          <a href='https://www.maitexa.com'>www.maitexa.com</a></p>
          <p style="font-size:12px; color:#666;">‚Äî Generated automatically by Maitexa Job Tracker ¬© 2025</p>
          </body></html>
          """
          msg.attach(MIMEText(html_content, "html"))

          if os.path.exists(pdf_file):
              with open(pdf_file, "rb") as f:
                  part = MIMEBase("application", "pdf")
                  part.set_payload(f.read())
              encoders.encode_base64(part)
              part.add_header("Content-Disposition", f"attachment; filename={pdf_file}")
              msg.attach(part)
          else:
              msg.attach(MIMEText("‚ö†Ô∏è PDF not found ‚Äì the scraper may have failed.", "plain"))

          with smtplib.SMTP("smtp.gmail.com", 587) as server:
              server.starttls()
              server.login(sender, password)
              server.send_message(msg)
          print("‚úÖ Email sent successfully!")
          EOF
