name: Kerala IT Park Job Scraper Automation

on:
  schedule:
    # ‚è∞ Runs automatically at 8:00 AM, 4:20 PM, and 9:00 PM IST
    - cron: '30 2,15 * * *'   # 8:00 AM & 9:00 PM IST
    - cron: '50 10 * * *'     # 4:20 PM IST
  workflow_dispatch:  # Manual trigger option

jobs:
  run-script:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Python 3.11
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # 3Ô∏è‚É£ Install Google Chrome (required for Selenium)
      - name: Install Chrome browser
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip
          wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt install -y ./google-chrome-stable_current_amd64.deb
          google-chrome --version

      # 4Ô∏è‚É£ Install all required Python dependencies (including python-docx)
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install selenium requests beautifulsoup4 reportlab webdriver-manager python-docx

      # 5Ô∏è‚É£ Run your scraper script to generate the latest PDF
      - name: Run Maitexa job scraper
        run: python app.py

      # 6Ô∏è‚É£ Upload the generated PDF (optional for backup)
      - name: Upload PDF Report
        uses: actions/upload-artifact@v4
        with:
          name: Maitexa_Job_Brochure
          path: Maitexa_Green_Adjusted_Brochure.pdf

      # 7Ô∏è‚É£ Email the latest generated PDF brochure
      - name: Send email with latest brochure
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
        run: |
          python - <<'EOF'
          import os, smtplib
          from email.mime.text import MIMEText
          from email.mime.multipart import MIMEMultipart
          from email.mime.base import MIMEBase
          from email import encoders
          from datetime import datetime

          sender = os.getenv("EMAIL_USER")
          password = os.getenv("EMAIL_PASS")
          recipients = [x.strip() for x in os.getenv("EMAIL_TO", "").split(",") if x.strip()]

          msg = MIMEMultipart()
          msg['From'] = sender
          msg['To'] = ", ".join(recipients)
          msg['Subject'] = f"üìÑ Maitexa Kerala IT Jobs ‚Äì {datetime.now().strftime('%d %b %Y, %I:%M %p')}"

          body = (
              "Dear Team,\n\n"
              "Attached is the latest Maitexa Kerala IT Parks job brochure with newly listed openings.\n\n"
              "Regards,\n"
              "Maitexa Technologies Pvt Ltd\n"
              "Kadannamanna, Malappuram, Kerala - 679324\n"
              "contact@maitexa.com | www.maitexa.com\n"
          )
          msg.attach(MIMEText(body, 'plain'))

          pdf_file = "Maitexa_Green_Adjusted_Brochure.pdf"
          if os.path.exists(pdf_file):
              with open(pdf_file, 'rb') as f:
                  part = MIMEBase('application', 'pdf')
                  part.set_payload(f.read())
              encoders.encode_base64(part)
              part.add_header('Content-Disposition', f'attachment; filename="{pdf_file}"')
              msg.attach(part)
          else:
              msg.attach(MIMEText("‚ö†Ô∏è PDF not found ‚Äì the scraper may have failed.", 'plain'))

          with smtplib.SMTP('smtp.gmail.com', 587) as server:
              server.starttls()
              server.login(sender, password)
              server.send_message(msg)

          print("‚úÖ Email sent successfully with the latest Maitexa brochure!")
          EOF
